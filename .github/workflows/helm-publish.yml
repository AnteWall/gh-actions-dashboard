name: Publish Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - 'deploy/helm/**'
      - '.github/workflows/helm-publish.yml'
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Get chart version
        id: chart_version
        run: |
          VERSION=$(grep '^version:' deploy/helm/gh-actions-dashboard/Chart.yaml | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          # For releases, use the tag version
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG_VERSION="${{ github.ref_name }}"
            # Remove 'v' prefix if present
            TAG_VERSION="${TAG_VERSION#v}"
            echo "version=$TAG_VERSION" >> $GITHUB_OUTPUT
          fi

      - name: Update Chart.yaml version for release
        if: github.event_name == 'release'
        run: |
          TAG_VERSION="${{ github.ref_name }}"
          TAG_VERSION="${TAG_VERSION#v}"
          sed -i "s/^version:.*/version: $TAG_VERSION/" deploy/helm/gh-actions-dashboard/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: \"$TAG_VERSION\"/" deploy/helm/gh-actions-dashboard/Chart.yaml

      - name: Lint Helm chart
        run: helm lint deploy/helm/gh-actions-dashboard

      - name: Package Helm chart
        run: |
          helm package deploy/helm/gh-actions-dashboard --destination .helm-packages

      - name: Push Helm chart to GHCR
        run: |
          helm push .helm-packages/gh-actions-dashboard-${{ steps.chart_version.outputs.version }}.tgz oci://ghcr.io/${{ github.repository_owner }}/charts
